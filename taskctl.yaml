pipelines:
  setup:
    - task: .env
    - task: build
    - task: dbreset
      depends_on: pg

contexts:
  houou:
    executable:
      bin: docker
      args: ["compose", "run", "--rm", "houou"]

  yakuman:
    executable:
      bin: docker
      args: ["compose", "run", "--rm", "yakuman"]

  houou-with-postgres:
    executable:
      bin: docker
      args: ["compose", "run", "--rm", "houou"]
    up: docker compose up -d postgres
    down: docker compose down postgres

tasks:
  .env:
    description: "Create .env from .env.sample"
    command: cp .env.sample .env

  build:
    description: "Build develop image for docker compose"
    command: docker compose build

  bundle:
    description: "Run bundle install manually"
    context: houou
    command: bundle install

  yarn:
    description: "Run yarn manually"
    context: yakuman
    command: yarn

  dbreset:
    description: "Repeatable DB initialization for development"
    context: houou-with-postgres
    command: bundle exec rails db:reset
